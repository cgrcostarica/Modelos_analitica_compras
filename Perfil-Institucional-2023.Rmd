---
title: Perfil Institucional INCIENSA 2023
date: "`r Sys.Date()`"
output: 
  rmdformats::robobook:
    self_contained: true
    #thumbnails: true
    lightbox: true
    #gallery: false
    code_folding: hide
    fd_print: paged
    df_print: paged
    highlight: tango
---
<style>
#toc {
  background:url(data:image/png;base64,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);
  background-size: contain;
  padding-top: 100px !important;
  background-repeat: no-repeat;
}
</style>

<style type="text/css">
div.page-inner {
  max-width: 10000px !important;
}
</style>

<style>
  body {
    margin-right: 2%;
    margin-left: 2%;
  }
.rpivotTable {
  overflow:auto;
  resize: both;
  box-shadow: 0 22px 70px 4px rgba(0,0,0,0.56);
  -moz-box-shadow: 0 22px 70px 4px rgba(0,0,0,0.56);
  -webkit-box-shadow: 0 22px 70px 4px rgba(0,0,0,0.56);
  /*-moz-box-shadow: 0px 10px 14px -7px #000000;    less aggressive version*/
  /*-webkit-box-shadow: 0px 10px 14px -7px #000000; less aggressive version*/
  /*box-shadow: 0px 10px 14px -7px #000000;         less aggressive version*/
  -moz-border-radius: 5px;
  -webkit-border-radius: 5px;
  border-radius: 5px;
  border: 1px solid white;
  padding: 5px;
  margin: 5px 20px 50px 5px;
  flex_dashboard;
  position: relative !important;
}
.pvtFilterBox {
  z-index: 9999 !important;
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,warning = FALSE, message = FALSE) 
library(ggplot2)
library(grid)
library(viridis) 
library(treemap)
library(plotly)
library(dplyr)
library(readr)
library(quantmod)
library(rpivotTable) 
library(data.table)
library(tidyverse)
library(summarytools)
library(GGally)
library(hrbrthemes)
options(scipen=999)


########################################################################
########################################################################
##### IDENTIFICACIÓN DE INSTITUCIÓN#####################################

#inst <- list("TSE","2400042156")
inst <- list("INCIENSA","3007045313")


########################################################################
########################################################################

siglas<- inst[[1]]
Institucion <- inst[[2]][1]

########################################################################
########################################################################

setwd("G:/Unidades compartidas/Fiscalizacion Preventiva de Compras Publicas/Fiscalización Preventiva de Compras Públicas/10_Perfil_Instituciones_SICOP")


# Cargando los datos ###################################################

# Definir las variables que son caracteres 

#caracter <- c("idInstitucion","nombreInstitucion","anno","tipoProcedimiento","cedulaProveedor",
#              "nombreProveedor","tipoProveedor","tamanoProveedor")
#A quien contratan
A_Quien_Contrata_Empresas <- read.csv(file = paste("G:/Unidades compartidas/Fiscalizacion Preventiva de Compras Publicas/Fiscalización Preventiva de Compras Públicas/10_Perfil_Instituciones_SICOP/AI/Perfil_2023_", siglas, "/", "A_Quien_Contrata_Empresas_",siglas, ".csv", sep = ""), header = TRUE, sep = ";", dec = ",",comment.char = "", strip.white = TRUE,stringsAsFactors = TRUE, encoding="UTF-8")

A_Quien_Contrata_Provincias <- read.csv(file = paste("G:/Unidades compartidas/Fiscalizacion Preventiva de Compras Publicas/Fiscalización Preventiva de Compras Públicas/10_Perfil_Instituciones_SICOP/AI/Perfil_2023_", siglas, "/", "A_Quien_Contrata_provincia_Empresas_",siglas, ".csv", sep = ""), header = TRUE, sep = ";", dec = ",",comment.char = "", strip.white = TRUE,stringsAsFactors = TRUE, encoding="UTF-8")

A_Quien_Contrata_Canton <- read.csv(file = paste("G:/Unidades compartidas/Fiscalizacion Preventiva de Compras Publicas/Fiscalización Preventiva de Compras Públicas/10_Perfil_Instituciones_SICOP/AI/Perfil_2023_", siglas, "/", "A_Quien_Contrata_canton_Empresas_",siglas, ".csv", sep = ""), header = TRUE, sep = ";", dec = ",",comment.char = "", strip.white = TRUE,stringsAsFactors = TRUE, encoding="UTF-8")

A_Quien_Contrata_Tamaño_Empresas <- read.csv(file = paste("G:/Unidades compartidas/Fiscalizacion Preventiva de Compras Publicas/Fiscalización Preventiva de Compras Públicas/10_Perfil_Instituciones_SICOP/AI/Perfil_2023_", siglas, "/", "A_Quien_Contrata_Tamano_Empresas_",siglas, ".csv", sep = ""), header = TRUE, sep = ";", dec = ",", comment.char = "", strip.white = TRUE, stringsAsFactors = TRUE, encoding="UTF-8")

A_Quien_Contrata_Tipo_Empresas <- read.csv(file = paste("G:/Unidades compartidas/Fiscalizacion Preventiva de Compras Publicas/Fiscalización Preventiva de Compras Públicas/10_Perfil_Instituciones_SICOP/AI/Perfil_2023_", siglas, "/", "A_Quien_Contrata_Tipo_Empresas_",siglas, ".csv", sep = ""), header = TRUE, sep = ";", dec = ",", comment.char = "", strip.white = TRUE, stringsAsFactors = TRUE, encoding="UTF-8")

#Qué contratan
Base_Que_Quien_Contratan <- read.csv(file = paste("G:/Unidades compartidas/Fiscalizacion Preventiva de Compras Publicas/Fiscalización Preventiva de Compras Públicas/10_Perfil_Instituciones_SICOP/AI/Perfil_2023_", siglas, "/", "Base_Que_Quien_Contratan_",siglas, ".csv", sep = ""), header = TRUE, sep = ";", dec = ",", comment.char = "", strip.white = TRUE, stringsAsFactors = TRUE, encoding="UTF-8")

Que_Contrata_codigo1 <- read.csv(file = paste("G:/Unidades compartidas/Fiscalizacion Preventiva de Compras Publicas/Fiscalización Preventiva de Compras Públicas/10_Perfil_Instituciones_SICOP/AI/Perfil_2023_", siglas, "/", "Que_Contrata_codigo1_",siglas, ".csv", sep = ""), header = TRUE, sep = ";", dec = ",",comment.char = "", strip.white = TRUE, stringsAsFactors = TRUE, encoding="UTF-8")

Que_Contrata_codigo16 <- read.csv(file = paste("G:/Unidades compartidas/Fiscalizacion Preventiva de Compras Publicas/Fiscalización Preventiva de Compras Públicas/10_Perfil_Instituciones_SICOP/AI/Perfil_2023_", siglas, "/", "Que_Contrata_codigo16_",siglas, ".csv", sep = ""), header = TRUE, sep = ";", dec = ",", comment.char = "", strip.white = TRUE, stringsAsFactors = TRUE, encoding="UTF-8")


#Cómo contratan
Como_Contratan <- read.csv(file = paste("G:/Unidades compartidas/Fiscalizacion Preventiva de Compras Publicas/Fiscalización Preventiva de Compras Públicas/10_Perfil_Instituciones_SICOP/AI/Perfil_2023_", siglas, "/", "Como_Contratan_",siglas, ".csv", sep = ""), header = TRUE, sep = ";", dec = ",",comment.char = "", strip.white = TRUE, stringsAsFactors = TRUE, encoding="UTF-8")

#Cuándo contratan
Cuando_Contrata <- read.csv(file = paste("G:/Unidades compartidas/Fiscalizacion Preventiva de Compras Publicas/Fiscalización Preventiva de Compras Públicas/10_Perfil_Instituciones_SICOP/AI/Perfil_2023_", siglas, "/", "Cuando_Contrata_",siglas, ".csv", sep = ""), header = TRUE, sep = ";", dec = ",", comment.char = "", strip.white = TRUE, stringsAsFactors = TRUE, encoding="UTF-8")

#Cuándo contratan
Cuanto_tipo_modalidad <- read.csv(file = paste("G:/Unidades compartidas/Fiscalizacion Preventiva de Compras Publicas/Fiscalización Preventiva de Compras Públicas/10_Perfil_Instituciones_SICOP/AI/Perfil_2023_", siglas, "/", "Cuanto_tipo_modalidad_",siglas, ".csv", sep = ""), header = TRUE, sep = ";", dec = ",", comment.char = "", strip.white = TRUE, stringsAsFactors = TRUE, encoding="UTF-8")

Cuanto_tipo_procedimiento <- read.csv(file = paste("G:/Unidades compartidas/Fiscalizacion Preventiva de Compras Publicas/Fiscalización Preventiva de Compras Públicas/10_Perfil_Instituciones_SICOP/AI/Perfil_2023_", siglas, "/", "Cuanto_tipo_procedimiento_",siglas, ".csv", sep = ""), header = TRUE, sep = ";", dec = ",",comment.char = "", strip.white = TRUE, stringsAsFactors = TRUE, encoding="UTF-8")

Analisis_Mercado <- read.csv(file = paste("G:/Unidades compartidas/Fiscalizacion Preventiva de Compras Publicas/Fiscalización Preventiva de Compras Públicas/10_Perfil_Instituciones_SICOP/AI/Perfil_2023_", siglas, "/", "Analisis_Mercado_",siglas, ".csv", sep = ""), header = TRUE, sep = ";", dec = ",",comment.char = "", strip.white = TRUE, stringsAsFactors = TRUE, encoding="UTF-8")

attach(A_Quien_Contrata_Empresas)
attach(A_Quien_Contrata_Provincias)
attach(A_Quien_Contrata_Tamaño_Empresas)
attach(A_Quien_Contrata_Tipo_Empresas)
attach(Base_Que_Quien_Contratan)
attach(Que_Contrata_codigo1)
attach(Que_Contrata_codigo16)
attach(Como_Contratan)
attach(Cuando_Contrata)
attach(Cuanto_tipo_modalidad)
attach(Cuanto_tipo_procedimiento)
attach(Analisis_Mercado)

#Preparación de datos, de Qué Contratan
str(Base_Que_Quien_Contratan)

#Convirtiendo los valores a numéricos
Base_Que_Quien_Contratan$Prec.Unit.Adj.Col<- as.numeric(Base_Que_Quien_Contratan$Prec.Unit.Adj.Col)
Base_Que_Quien_Contratan$Monto_linea_colones<-as.numeric(Base_Que_Quien_Contratan$Monto_linea_colones)
Base_Que_Quien_Contratan$cantidad_adjudicada<-as.numeric(Base_Que_Quien_Contratan$cantidad_adjudicada)
Base_Que_Quien_Contratan$codigo_producto_1<-as.factor(Base_Que_Quien_Contratan$codigo_producto_1)
Base_Que_Quien_Contratan$codigo_producto_16<-as.factor(Base_Que_Quien_Contratan$codigo_producto_16)

Base_Que_Quien_Contratan$anno<-as.numeric(Base_Que_Quien_Contratan$anno)

#Eliminando los caracteres que pueden afectar la corrida de las tablas dinámicas
Base_Que_Quien_Contratan$nro_procedimiento <- str_replace_all(Base_Que_Quien_Contratan$nro_procedimiento ,"[^[:graph:]]", " ") 


Base_Que_Quien_Contratan$nombre_identificacion <- str_replace_all(Base_Que_Quien_Contratan$nombre_identificacion ,"[^[:graph:]]", " ") 

Base_Que_Quien_Contratan$tipo_procedimiento<- str_replace_all(Base_Que_Quien_Contratan$tipo_procedimiento,"[^[:graph:]]", " ") 

Base_Que_Quien_Contratan$modalidad_procedimiento<- str_replace_all(Base_Que_Quien_Contratan$modalidad_procedimiento,"[^[:graph:]]", " ") 

Base_Que_Quien_Contratan$nombre_proveedor<- str_replace_all(Base_Que_Quien_Contratan$nombre_proveedor,"[^[:graph:]]", " ") 

Base_Que_Quien_Contratan$tipo_proveedor<- str_replace_all(Base_Que_Quien_Contratan$tipo_proveedor,"[^[:graph:]]", " ") 

Base_Que_Quien_Contratan$tamano_proveedor<- str_replace_all(Base_Que_Quien_Contratan$tamano_proveedor,"[^[:graph:]]", " ") 

Base_Que_Quien_Contratan$provincia<- str_replace_all(Base_Que_Quien_Contratan$provincia,"[^[:graph:]]", " ") 


Base_Que_Quien_Contratan<- as.data.frame(Base_Que_Quien_Contratan)


#Preparación de datos, de Cómo Contratan
#str(Como_Contratan)

#Convirtiendo los valores a numéricos
Como_Contratan$anno<- as.numeric(Como_Contratan$anno)
Como_Contratan$Conteo_lineas<-as.numeric(Como_Contratan$Conteo_lineas)
Como_Contratan$Conteo_procedimientos<-as.numeric(Como_Contratan$Conteo_procedimientos)


#Eliminando los caracteres que pueden afectar la corrida de las tablas dinámicas
Como_Contratan$tipo_procedimiento <- str_replace_all(Como_Contratan$tipo_procedimiento ,"[^[:graph:]]", " ") 


#Preparación de datos, de Cuánto Contratan
#str(Cuanto_tipo_modalidad)
#str(Cuanto_tipo_procedimiento)

#Convirtiendo los valores a numéricos
Cuanto_tipo_modalidad$anno<- as.numeric(Cuanto_tipo_modalidad$anno)
Cuanto_tipo_modalidad$Dif_publi_adj_firme_Institucion<-as.numeric(Cuanto_tipo_modalidad$Dif_publi_adj_firme_Institucion)
Cuanto_tipo_modalidad$Dif_publi_contrato_Institucion<-as.numeric(Cuanto_tipo_modalidad$Dif_publi_contrato_Institucion)
Cuanto_tipo_modalidad$Dif_adj_firme_contrato_Institucion<-as.numeric(Cuanto_tipo_modalidad$Dif_adj_firme_contrato_Institucion)
Cuanto_tipo_modalidad$Conteo_Institucion<-as.numeric(Cuanto_tipo_modalidad$Conteo_Institucion)

Cuanto_tipo_procedimiento$anno<- as.numeric(Cuanto_tipo_procedimiento$anno)
Cuanto_tipo_procedimiento$Dif_publi_adj_firme_Institucion<-as.numeric(Cuanto_tipo_procedimiento$Dif_publi_adj_firme_Institucion)
Cuanto_tipo_procedimiento$Dif_publi_contrato_Institucion<-as.numeric(Cuanto_tipo_procedimiento$Dif_publi_contrato_Institucion)
Cuanto_tipo_procedimiento$Dif_adj_firme_contrato_Institucion<-as.numeric(Cuanto_tipo_procedimiento$Dif_adj_firme_contrato_Institucion)
Cuanto_tipo_procedimiento$Conteo_Institucion<-as.numeric(Cuanto_tipo_procedimiento$Conteo_Institucion)
Cuanto_tipo_procedimiento$tipo_procedimiento <- gsub("\xf3", "o", Cuanto_tipo_procedimiento$tipo_procedimiento)
Cuanto_tipo_procedimiento$tipo_procedimiento <- gsub("ó", "o", Cuanto_tipo_procedimiento$tipo_procedimiento)
Cuanto_tipo_procedimiento$tipo_procedimiento <- gsub("<f3>", "o", Cuanto_tipo_procedimiento$tipo_procedimiento)
#Eliminando los caracteres que pueden afectar la corrida de las tablas dinámicas
Cuanto_tipo_modalidad$modalidad_procedimiento <- str_replace_all(Cuanto_tipo_modalidad$modalidad_procedimiento ,"[^[:graph:]]", " ") 

Cuanto_tipo_procedimiento$tipo_procedimiento <- str_replace_all(Cuanto_tipo_procedimiento$tipo_procedimiento ,"[^[:graph:]]", " ") 


#Preparación de datos, de Cómo Contratan
#str(Cuando_Contrata)

#Convirtiendo los valores a numéricos
Cuando_Contrata$anno<- as.numeric(Cuando_Contrata$anno)
Cuando_Contrata$mes<-as.numeric(Cuando_Contrata$mes)
Cuando_Contrata$Conteo_lineas<-as.numeric(Cuando_Contrata$Conteo_lineas)
Cuando_Contrata$Conteo_procedimientos<-as.numeric(Cuando_Contrata$Conteo_procedimientos)


#Eliminando los caracteres que pueden afectar la corrida de las tablas dinámicas
Cuando_Contrata$nro_procedimiento <- str_replace_all(Cuando_Contrata$nro_procedimiento ,"[^[:graph:]]", " ") 





#Preparación de datos, de Cómo Contratan
#str(A_Quien_Contrata_Empresas)
#str(A_Quien_Contrata_Provincias)
#str(A_Quien_Contrata_Tamaño_Empresas)
#str(A_Quien_Contrata_Tipo_Empresas)

#Convirtiendo los valores a numéricos
A_Quien_Contrata_Empresas$anno<- as.numeric(A_Quien_Contrata_Empresas$anno)
A_Quien_Contrata_Empresas$Conteo_lineas<-as.numeric(A_Quien_Contrata_Empresas$Conteo_lineas)
A_Quien_Contrata_Empresas$Conteo_procedimientos<-as.numeric(A_Quien_Contrata_Empresas$Conteo_procedimientos)
A_Quien_Contrata_Empresas$total_gastado<-as.numeric(A_Quien_Contrata_Empresas$total_gastado)

A_Quien_Contrata_Provincias$anno<- as.numeric(A_Quien_Contrata_Provincias$anno)
A_Quien_Contrata_Provincias$Conteo_lineas<-as.numeric(A_Quien_Contrata_Provincias$Conteo_lineas)
A_Quien_Contrata_Provincias$Conteo_procedimientos<-as.numeric(A_Quien_Contrata_Provincias$Conteo_procedimientos)
A_Quien_Contrata_Provincias$total_gastado<-as.numeric(A_Quien_Contrata_Provincias$total_gastado)

A_Quien_Contrata_Tamaño_Empresas$anno<- as.numeric(A_Quien_Contrata_Tamaño_Empresas$anno)
A_Quien_Contrata_Tamaño_Empresas$Conteo_lineas<-as.numeric(A_Quien_Contrata_Tamaño_Empresas$Conteo_lineas)
A_Quien_Contrata_Tamaño_Empresas$Conteo_procedimientos<-as.numeric(A_Quien_Contrata_Tamaño_Empresas$Conteo_procedimientos)
A_Quien_Contrata_Tamaño_Empresas$total_gastado<-as.numeric(A_Quien_Contrata_Tamaño_Empresas$total_gastado)

A_Quien_Contrata_Tipo_Empresas$anno<- as.numeric(A_Quien_Contrata_Tipo_Empresas$anno)
A_Quien_Contrata_Tipo_Empresas$Conteo_lineas<-as.numeric(A_Quien_Contrata_Tipo_Empresas$Conteo_lineas)
A_Quien_Contrata_Tipo_Empresas$Conteo_procedimientos<-as.numeric(A_Quien_Contrata_Tipo_Empresas$Conteo_procedimientos)
A_Quien_Contrata_Tipo_Empresas$total_gastado<-as.numeric(A_Quien_Contrata_Tipo_Empresas$total_gastado)


#Eliminando los caracteres que pueden afectar la corrida de las tablas dinámicas
A_Quien_Contrata_Provincias$provincia <- str_replace_all(A_Quien_Contrata_Provincias$provincia ,"[^[:graph:]]", " ") 
A_Quien_Contrata_Tamaño_Empresas$tamano_proveedor <- str_replace_all(A_Quien_Contrata_Tamaño_Empresas$tamano_proveedor ,"[^[:graph:]]", " ") 
A_Quien_Contrata_Tipo_Empresas$tipo_proveedor <- str_replace_all(A_Quien_Contrata_Tipo_Empresas$tipo_proveedor ,"[^[:graph:]]", " ") 


setwd("G:/Unidades compartidas/Fiscalizacion Preventiva de Compras Publicas/Fiscalización Preventiva de Compras Públicas/10_Perfil_Instituciones_SICOP/Resumen_Perfiles_HTML")



#View(QCcompra )
#QCcompra$cantidadUnidades<-as.numeric(levels(QCcompra$cantidadUnidades))[QCcompra$cantidadUnidades]
#QCcompra$monto<-as.numeric(levels(QCcompra$monto))[QCcompra$monto]
#QCcompra$annoAdj<-as.numeric(levels(QCcompra$annoAdj))[QCcompra$annoAdj]

```


## ¿QUÉ SE COMPRA? {.tabset .tabset-fade .tabset-pills}
En esta sección se puede visualizar un gráfico de dispersión donde se pueden ver todos los procedimientos de contratación realizados y el monto de cada uno.Adicionalmente, el gráfico es interactivo por lo que al mover el cursor en el gráfico, se pude observar información extra.

```{r, out.width='110%', out.height='140%', out.extra='140%'}
#Comparación de ambas instituciones
#grafico.burbujas.1 <- QCcompra %>%
# ggplot( aes(monto, cantidadUnidades, size = cantidadUnidades, color=tipoProducto, labels=(familiaProducto)) +
# geom_point() +
# scale_x_log10() +
# scale_y_log10()+
# theme_bw()+
# facet_wrap(~nombreInstitucion)

#ggplotly(grafico.burbujas.1)
#QCcompra<-filter(QCcompra, QCcompra$nombreInstitucion == "Correos de Costa Rica S.A.")
#names(Base_Que_Quien_Contratan)
#Análisis por institución
grafico.burbujas <- Base_Que_Quien_Contratan %>%
  filter(anno>"2014") %>%
  ggplot( aes(Monto_linea_colones, cantidad_adjudicada, size = cantidad_adjudicada, color=codigo_producto_1, labels=(anno)))+
  geom_point() +
  scale_x_log10(FALSE) +
  scale_y_log10(FALSE) +
  theme_bw()

ggplotly(grafico.burbujas)


```


### Tabla dinámica sobre ¿Qué se compra? Considerando 1 digito del bien {.tabset .tabset-fade .tabset-pills}
En esta tabla dinámica se puede ver a primera vista la suma de montos de los procedimientos para cada código de producto. En este tipo de tablas, se pueden incluir las variables que desee de las disponibles y también filtrar por distinta información. También, en este recuadro se puede cambiar el tipo de gráfico en el que se muestran los datos.
```{r, out.width='110%', out.height='140%', out.extra='140%'}
# Create a copy of the original data frame
data_copy <- Base_Que_Quien_Contratan

# Modify the column names in the copied data frame
colnames(data_copy) <- c("Cédula de institución","Número de procedimiento", "Número de línea","Codigo Producto a 1 dígito",   "Codigo Producto a 16 dígitos", "Cantidad Adjudicada", "Precio Unitario Adjudicado en Colones", "Monto en colones de la línea", "Nombre del producto", "Tipo de procedimiento", "Modalidad del procedimiento", "Cédula del proveedor", "Nombre del proveedor", "Tipo del proveedor", "Tamaño del proveedor","Provincia", "Cantón","Año" )

# Create the pivot table with the modified column names
rpivotTable(data_copy, 
            rows = c("Codigo Producto a 1 dígito"), 
            cols = "Año", 
            vals = "Monto en colones de la línea", 
            aggregatorName = "Sum", 
            rendererName = "Table", 
            width = "100%", 
            height = "500px")

```


## ¿CÓMO SE COMPRA? {.tabset .tabset-fade .tabset-pills}
En este gráfico se puede visualizar la cantidad de procedimientos realizadas por año y separados por el tipo de procedimiento que se realizó.
```{r, out.width='75%', out.height='75%'}
Como_Contratan <- Como_Contratan %>% arrange(anno)
Como_Contratan_1 <- Como_Contratan
Como_Contratan_1$id <- seq(1, nrow(Como_Contratan_1))

# Get the name and the y position of each label
label_Como_Contratan <- Como_Contratan_1
number_of_bar <- nrow(label_Como_Contratan)
angle <- 90 - 360 * (label_Como_Contratan$id-0.5) / number_of_bar
label_Como_Contratan$hjust <- ifelse(angle < -90, 1, 0)
label_Como_Contratan$angle <- ifelse(angle < -90, angle+180, angle)

# prepare a data frame for base lines
base_Como_Contratan <- Como_Contratan_1 %>% 
  group_by(anno) %>% 
  summarize(start = min(id), end = max(id)) %>% 
  rowwise() %>% 
  mutate(title = mean(c(start, end)))

# prepare a data frame for grid (scales)
grid_Como_Contratan <- base_Como_Contratan
grid_Como_Contratan$end <- grid_Como_Contratan$end + 1
grid_Como_Contratan$start <- grid_Como_Contratan$start - 1

caption_text <- paste("Fuente: Datos extraídos del SICOP al", format(Sys.Date(), "%d-%m-%Y"))

# Make the plot
p <- ggplot(Como_Contratan_1, aes(x = as.factor(id), y = Conteo_procedimientos, fill = anno)) +
  geom_bar(stat = "identity", alpha = 1) +
  geom_segment(data = grid_Como_Contratan, aes(x = end, y = 100, xend = start, yend = 100), colour = "grey", alpha = 1, size = 0.3) +
  geom_segment(data = grid_Como_Contratan, aes(x = end, y = 200, xend = start, yend = 200), colour = "grey", alpha = 1, size = 0.3) +
  geom_segment(data = grid_Como_Contratan, aes(x = end, y = 300, xend = start, yend = 300), colour = "grey", alpha = 1, size = 0.3) +
  geom_segment(data = grid_Como_Contratan, aes(x = end, y = 400, xend = start, yend = 400), colour = "grey", alpha = 1, size = 0.3) +
  geom_segment(data = grid_Como_Contratan, aes(x = end, y = 500, xend = start, yend = 500), colour = "grey", alpha = 1, size = 0.3) +
  geom_segment(data = grid_Como_Contratan, aes(x = end, y = 600, xend = start, yend = 600), colour = "grey", alpha = 1, size = 0.3) +
  annotate("text", x = rep(max(Como_Contratan_1$id) + 1, 6), y = c(100, 200, 300, 400, 500, 600), label = c("100", "200", "300", "400", "500", "600"), color = "grey", size = 3, angle = 0, fontface = "bold", hjust = 1) +
  ylim(-100, 1000) +
  theme_minimal() +
  theme(
    axis.text = element_blank(),
    axis.title = element_blank(),
    panel.grid = element_blank(),
    plot.margin = unit(rep(-1, 6), "cm")
  ) +
  coord_polar() +
  geom_text(data = label_Como_Contratan, aes(x = id, y = Conteo_procedimientos + 10, label = tipo_procedimiento), color = "black", fontface = "bold", alpha = 0.6, size = 2.5, angle = label_Como_Contratan$angle, hjust = label_Como_Contratan$hjust) +
  geom_segment(data = base_Como_Contratan, aes(x = start, y = -5, xend = end, yend = -5), colour = "black", alpha = 0.8, size = 0.6) +
  geom_text(data = base_Como_Contratan, aes(x = title, y = -18, label = anno), hjust = 1, colour = "black", alpha = 0.8, size = 1.75, fontface = "bold", inherit.aes = FALSE) +
  labs(fill = "Anno")  # Add title and legend labels

cowplot::ggdraw(p) +
  cowplot::draw_label(caption_text, x = 0.5, y = 0, hjust = 0.5, vjust = -1, fontface = "italic", size = 10)

grid.text("Cantidad de procedimientos \n según del tipo de procedimiento por año", x = 0.45, y = 0.95, gp = gpar(fontsize = 12, fontface = "bold"))
```

### Tabla dinámica sobre ¿Cómo se compra? {.tabset .tabset-fade .tabset-pills}
En esta tabla dinámica se puede ver a primera vista el conteo de los procedimientos para cada tipo de procedimiento por año. Aquí se pueden realizar los cambios anteriormente comentados.
```{r, out.width='100%', out.height='100%'}
data_copy <- Como_Contratan
# Modify the column names in the copied data frame
colnames(data_copy) <- c("Tipo de procedimiento", "Año", "Conteo de líneas", "Conteo de procedimientos")
rpivotTable(data = data_copy , rows = c("Tipo de procedimiento"),cols=c("Año"), vals = "Conteo de procedimientos", aggregatorName = "Sum", rendererName = "Table", width="100%", height="500px")

# rpivotTable(data = Como_Contratan , rows = c( "tipo_procedimiento"),cols="anno", vals = "Conteo_procedimientos", aggregatorName = "Sum", rendererName = "Table", width="100%", height="500px")
```


## ¿CUÁNTO SE TARDA? {.tabset .tabset-fade .tabset-pills}
En este gráfico se puede visualizar la diferencia entre la fecha de publicación y del contrato realizadas por año y separados por el tipo de procedimiento que se realizó.
```{r, out.width='75%', out.height='75%'}
#CUANTO
Cuanto_tipo_procedimiento <- Cuanto_tipo_procedimiento %>% arrange(anno)
Cuanto_tipo_procedimiento_1 <- Cuanto_tipo_procedimiento
Cuanto_tipo_procedimiento_1$id <- seq(1, nrow(Cuanto_tipo_procedimiento_1))

# Get the name and the y position of each label
label_Cuanto_tipo_procedimiento <- Cuanto_tipo_procedimiento_1
number_of_bar <- nrow(label_Cuanto_tipo_procedimiento)
angle <- 90 - 360 * (label_Cuanto_tipo_procedimiento$id-0.5) /number_of_bar     # I substract 0.5 because the letter must have the angle of the center of the bars. Not extreme right(1) or extreme left (0)
label_Cuanto_tipo_procedimiento$hjust <- ifelse( angle < -90, 1, 0)
label_Cuanto_tipo_procedimiento$angle <- ifelse(angle < -90, angle+180, angle)

# prepare a data frame for base lines
base_Cuanto_tipo_procedimiento <- Cuanto_tipo_procedimiento_1 %>% 
  group_by(anno) %>% 
  summarize(start=min(id), end=max(id)) %>% 
  rowwise() %>% 
  mutate(title=mean(c(start, end)))

# prepare a data frame for grid (scales)
grid_Cuanto_tipo_procedimiento <- base_Cuanto_tipo_procedimiento
grid_Cuanto_tipo_procedimiento$end <- grid_Cuanto_tipo_procedimiento$end + 1
grid_Cuanto_tipo_procedimiento$start <- grid_Cuanto_tipo_procedimiento$start - 1
#grid_data <- grid_data[-1,]

caption_text <- paste("Fuente: Datos extraídos del SICOP al", format(Sys.Date(), "%d-%m-%Y"))

# Make the plot
# Make the plot
p <- ggplot(Cuanto_tipo_procedimiento_1, aes(x = as.factor(id), y = Dif_publi_contrato_Institucion, fill = anno)) +
  geom_bar(stat = "identity", alpha = 1) +
  # Add val=100/75/50/25 lines
  geom_segment(data = grid_Cuanto_tipo_procedimiento, aes(x = end, y = 100, xend = start, yend = 100), colour = "grey", alpha = 1, size = 0.3, inherit.aes = FALSE) +
  geom_segment(data = grid_Cuanto_tipo_procedimiento, aes(x = end, y = 200, xend = start, yend = 200), colour = "grey", alpha = 1, size = 0.3, inherit.aes = FALSE) +
  geom_segment(data = grid_Cuanto_tipo_procedimiento, aes(x = end, y = 300, xend = start, yend = 300), colour = "grey", alpha = 1, size = 0.3, inherit.aes = FALSE) +
  geom_segment(data = grid_Cuanto_tipo_procedimiento, aes(x = end, y = 400, xend = start, yend = 400), colour = "grey", alpha = 1, size = 0.3, inherit.aes = FALSE) +
  geom_segment(data = grid_Cuanto_tipo_procedimiento, aes(x = end, y = 500, xend = start, yend = 500), colour = "grey", alpha = 1, size = 0.3, inherit.aes = FALSE) +
  geom_segment(data = grid_Cuanto_tipo_procedimiento, aes(x = end, y = 600, xend = start, yend = 600), colour = "grey", alpha = 1, size = 0.3, inherit.aes = FALSE) +
  geom_segment(data = grid_Cuanto_tipo_procedimiento, aes(x = end, y = 700, xend = start, yend = 700), colour = "grey", alpha = 1, size = 0.3, inherit.aes = FALSE) +
  geom_segment(data = grid_Cuanto_tipo_procedimiento, aes(x = end, y = 800, xend = start, yend = 800), colour = "grey", alpha = 1, size = 0.3, inherit.aes = FALSE) +
  geom_segment(data = grid_Cuanto_tipo_procedimiento, aes(x = end, y = 900, xend = start, yend = 900), colour = "grey", alpha = 1, size = 0.3, inherit.aes = FALSE) +
  geom_segment(data = grid_Cuanto_tipo_procedimiento, aes(x = end, y = 1000, xend = start, yend = 1000), colour = "grey", alpha = 1, size = 0.3, inherit.aes = FALSE) +
  geom_segment(data = grid_Cuanto_tipo_procedimiento, aes(x = end, y = 1100, xend = start, yend = 1100), colour = "grey", alpha = 1, size = 0.3, inherit.aes = FALSE) +
  geom_segment(data = grid_Cuanto_tipo_procedimiento, aes(x = end, y = 1200, xend = start, yend = 1200), colour = "grey", alpha = 1, size = 0.3, inherit.aes = FALSE) +
  # Add text showing the value of each 100/75/50/25 lines
  annotate("text", x = rep(max(Cuanto_tipo_procedimiento_1$id) + 1, 12), y = c(100, 200, 300, 400, 500, 600, 700, 800, 900, 1000, 1100, 1200), label = c("100", "200", "300", "400", "500", "600", "700", "800", "900", "1000", "1100", "1200"), color = "grey", size = 3, angle = 0, fontface = "bold", hjust = 1) +
  ylim(-100, 1400) +
  theme_minimal() +
  theme(
    axis.text = element_blank(),
    axis.title = element_blank(),
    panel.grid = element_blank(),
    plot.margin = unit(rep(-1, 6), "cm"),
    legend.position = "right",  # Adjust the position of the legend
    legend.title = element_text(size = 12),  # Set the legend title size
    legend.text = element_text(size = 10)  # Set the legend text size
  ) +
  coord_polar() +
  geom_text(data = label_Cuanto_tipo_procedimiento, aes(x = id, y = Dif_publi_contrato_Institucion + 10, label = tipo_procedimiento, hjust = hjust), color = "black", fontface = "bold", alpha = 0.6, size = 2.5, angle = label_Cuanto_tipo_procedimiento$angle, inherit.aes = FALSE) +
  # Add base line information
  geom_segment(data = base_Cuanto_tipo_procedimiento, aes(x = start, y = -5, xend = end, yend = -5), colour = "black", alpha = 0.8, size = 0.6, inherit.aes = FALSE) +
  geom_text(data = base_Cuanto_tipo_procedimiento, aes(x = title, y = -18, label = anno), hjust = 1, colour = "black", alpha = 0.8, size = 1.75, fontface = "bold", inherit.aes = FALSE) +
  labs(title = "Title of the Graph", fill = "Anno")  # Add title and legend labels

cowplot::ggdraw(p) +
  cowplot::draw_label(caption_text, x = 0.5, y = 0, hjust = 0.5, vjust = -1, fontface = "italic", size = 10)

grid.text("Diferencia entre la publicación y el contrato \n según del tipo de procedimiento por año", x = 0.45, y = 0.95, gp = gpar(fontsize = 12, fontface = "bold"))
```

### Tabla dinámica sobre ¿Cuánto se tarda en comprar? tipo de procedimiento {.tabset .tabset-fade .tabset-pills}
En esta tabla dinámica se puede ver a primera vista la diferencia entre fecha de publicación y del contrato para cada tipo de procedimiento por año. Aquí se pueden realizar los cambios anteriormente comentados.
```{r, out.width='100%', out.height='100%'}
# Create a copy of the original data frame
data_copy <- Cuanto_tipo_procedimiento

# Modify the column names in the copied data frame
colnames(data_copy) <- c("Cédula de institución","Tipo de procedimiento","Año" ,"Diferencia entre fecha de publicación y de adjudicación","Diferencia entre fecha de publicación y del contrato","Diferencia entre fecha de adjudicación y del contrato","Conteo de la institución")

rpivotTable(data = data_copy, rows = c("Tipo de procedimiento"),cols=c("Año"), vals = "Diferencia entre fecha de publicación y del contrato", aggregatorName = "Sum", rendererName = "Table", width="100%", height="500px")

# rpivotTable(data = Cuanto_tipo_procedimiento, rows = c( "tipo_procedimiento"),cols="anno", vals = "Dif_publi_contrato_Institucion", aggregatorName = "Sum", rendererName = "Table", width="100%", height="500px")
```

### Tabla dinámica sobre ¿Cuánto se tarda en comprar? tipo de modalidad {.tabset .tabset-fade .tabset-pills}
En esta tabla dinámica se puede ver a primera vista la diferencia entre fecha de publicación y del contrato para cada modalidad de procedimiento por año. Aquí se pueden realizar los cambios anteriormente comentados.
```{r, out.width='100%', out.height='100%'}
# Create a copy of the original data frame
data_copy <- Cuanto_tipo_modalidad

# Modify the column names in the copied data frame
colnames(data_copy) <- c("Cédula de institución","Modalidad del procedimiento","Año" ,"Diferencia entre fecha de publicación y de adjudicación","Diferencia entre fecha de publicación y del contrato","Diferencia entre fecha de adjudicación y del contrato","Conteo de la institución")

rpivotTable(data = data_copy, rows = c( "Modalidad del procedimiento"),cols=c("Año"), vals = "Diferencia entre fecha de publicacón y del contrato", aggregatorName = "Sum", rendererName = "Table", width="100%", height="500px")
```



## ¿CUÁNDO SE COMPRA? {.tabset .tabset-fade .tabset-pills}
En este gráfico se puede visualizar el conteo de procedimientos realizados por mes y separados por el año en que se realizó.
```{r, out.width='75%', out.height='75%'}
# Summarize the data by calculating the sum of Conteo_procedimientos by mes and anno
summarized_data <- Cuando_Contrata %>%
  group_by(anno, mes) %>%
  summarize(total_procedimientos = sum(Conteo_procedimientos))

# Plot the graph
ggplot(summarized_data, aes(x = mes, y = total_procedimientos, group = anno, fill = as.factor(anno))) +
  geom_area() +
  scale_fill_viridis(discrete = TRUE) +
  theme(
    legend.position = "none",
    plot.title = element_text(size = 14),
    axis.text.x = element_text(angle = 45, hjust = 1)  # Incline x-axis labels
  ) +
  theme_minimal() +
  scale_x_continuous(
    breaks = 1:12,  # Set the breaks to represent each month
    labels = c(
      "enero", "febrero", "marzo", "abril", "mayo", "junio",
      "julio", "agosto", "septiembre", "octubre", "noviembre", "diciembre"
    )  # Use month names as labels
  ) +
  labs(color = "Anno", fill = "Anno")  # Label for color legend


```


### Tabla dinámica sobre ¿Cuándo se compra? {.tabset .tabset-fade .tabset-pills}
En esta tabla dinámica se puede ver a primera vista el conteo de procedimientos para cada mes por año. Aquí se pueden realizar los cambios anteriormente comentados.
```{r, out.width='100%', out.height='100%'}
# Create a copy of the original data frame
data_copy <- Cuando_Contrata

# Modify the column names in the copied data frame
colnames(data_copy) <- c("Número del procedimiento","Año","Mes","Conteo de líneas", "Conteo de procedimientos" )

rpivotTable(data = data_copy, rows = c("Año","Mes"),cols=c("Año"), vals = "Conteo de procedimientos", aggregatorName = "Sum", rendererName = "Table", width="100%", height="500px", sorter = TRUE)
```


## ¿A QUIÉN SE LE COMPRA? {.tabset .tabset-fade .tabset-pills}
```{r, out.width='75%', out.height='75%'}
# Infografia ¿CON QUIEN SE COMPRA? ###################################
# Revisando la dimension de los datos, los nombres de variables y la estructura de los mismos #####################
#dim(CONQUIEN)
#names(CONQUIEN)
#str(CONQUIEN)

#CONQUIENGRAFICO <- CONQUIEN[,.N, keyby = .(nombreInstitucion,tamanoProveedor)][,Porcentaje := (N/sum(N))*100, keyby = .(nombreInstitucion)][order(nombreInstitucion,-Porcentaje)][]

#CONQUIEN<-filter(CONQUIEN, CONQUIEN$nombreInstitucion == "Correos de Costa Rica S.A.")
#CONQUIENGRAFICO<-filter(CONQUIENGRAFICO, CONQUIENGRAFICO$nombreInstitucion == "Correos de Costa Rica S.A.")


#mycols <- c("#0073C2FF", "#EFC000FF", "#868686FF", "#CD534CFF", "#CD589CFF")

#ggplot(CONQUIENGRAFICO, aes(x="", y=Porcentaje, fill=tamanoProveedor)) +
#  geom_bar(stat="identity", width=1)+ 
#  facet_grid(facets=. ~ nombreInstitucion)+
#  coord_polar("y", start=0) + 
#  geom_text(aes(label = paste0(round(Porcentaje,digits = 1), "%")), position = position_stack(vjust = 0.5))+
#  scale_fill_manual(values=mycols) +
#  theme_void()+
#  theme( strip.text.x = element_text(face="bold"))+
#  scale_fill_discrete(name = "Tamaño del Proveedor")
#View(CONQUIEN)

```

### Tabla dinámica sobre ¿A quién se le compra? Tamaño de empresas {.tabset .tabset-fade .tabset-pills}
En esta tabla dinámica se puede ver a primera vista el total gastado para cada tamaño de empresa por año. Aquí se pueden realizar los cambios anteriormente comentados.
```{r, out.width='100%', out.height='100%'}
# Create a copy of the original data frame
data_copy <- A_Quien_Contrata_Tamaño_Empresas

# Modify the column names in the copied data frame
colnames(data_copy) <- c("Tamaño del proveedor","Año","Conteo de líneas", "Conteo de procedimientos" ,"Total gastado")

rpivotTable(data = data_copy, rows = c("Tamaño del proveedor"),cols=c("Año"), vals = "Total gastado", aggregatorName = "Sum", rendererName = "Table", width="100%", height="500px")
```

### Tabla dinámica sobre ¿A quién se le compra? Provincias {.tabset .tabset-fade .tabset-pills}
En esta tabla dinámica se puede ver a primera vista el total gastado para cada provincia por año. Aquí se pueden realizar los cambios anteriormente comentados.
```{r, out.width='100%', out.height='100%'}
# Create a copy of the original data frame
data_copy <- A_Quien_Contrata_Provincias

# Modify the column names in the copied data frame
colnames(data_copy) <- c( "Provincia","Año","Conteo de líneas", "Conteo de procedimientos" ,"Total gastado")

rpivotTable(data = data_copy, rows = c("Provincia"),cols=c("Año"), vals = "Total gastado", aggregatorName = "Sum", rendererName = "Table", width="100%", height="500px")
```

### Mapa sobre ¿A quién se le compra? Canton {.tabset .tabset-fade .tabset-pills}
En este mapa se puede ver el total gastado para cada canton por año.
```{r, out.width='100%', out.height='100%'}
# Create a copy of the original data frame
data_copy <- A_Quien_Contrata_Canton

# Modify the column names in the copied data frame
colnames(data_copy) <- c( "Provincia","Canton","Año","Conteo de líneas", "Conteo de procedimientos" ,"Total gastado")

library(sf)
suppressPackageStartupMessages(library(htmltools))

# Lectura de datos
canton <- st_read("G:/Unidades compartidas/Fiscalizacion Preventiva de Compras Publicas/Fiscalización Preventiva de Compras Públicas/10_Perfil_Instituciones_SICOP/Datos geoespaciales/canton.shp")

cantones<- canton %>% st_set_crs(4326) %>% st_transform(crs=32736)
suppressPackageStartupMessages(library(leaflet))
#mapa_gam <- subset(cantones, canton %in% cantones)
mapa <- st_transform(cantones, crs = "+proj=longlat +ellps=WGS84 +no_defs")
to_upper <- function(x) chartr("áéíóúÁÉÍÓÚ", "aeiouAEIOU", x)

#Corrigiendo los valores que pueden generar problema
mapa$id <- to_upper(mapa$canton)

#head(mapa)
#head(datos_graficos_final)
mapa$canton <- str_to_title(mapa$canton)
mapa$canton <- to_upper(mapa$canton)

mapa_final <- merge(mapa, data_copy, 
                    by.x = c("canton"), by.y = c("Canton"))

mapa_final$Provincia <- as.character(mapa_final$Provincia)

etiquetas <- map2(mapa_final$Provincia, mapa_final$canton, function(provincia, canton) {
  etiqueta <- str_c(
    "<strong>Provincia: </strong>", provincia,
    "<br/>",
    "<strong>Cantón: </strong>", canton,
    "<br/>"
  )
  
  indices <- which(mapa_final$canton == canton)
  indices <- indices[order(mapa_final$Año[indices])]  # Sort indices based on year
  
  for (i in indices) {
    etiqueta <- str_c(
      etiqueta,
      "<strong>Año: </strong>", mapa_final$Año[i],
      "<br/>",
      "- Ingresos: ", ifelse(is.na(mapa_final$"Total gastado"[i]), "No Disponible", round(mapa_final$"Total gastado"[i], 2)),
      "  - Procedimientos: ", ifelse(is.na(mapa_final$"Conteo de procedimientos"[i]), "No Disponible", round(mapa_final$"Conteo de procedimientos"[i], 2)),
      "  - Líneas: ", ifelse(is.na(mapa_final$"Conteo de líneas"[i]), "No Disponible", round(mapa_final$"Conteo de líneas"[i], 2)),
      "<br/>"
    )
  }
  
  HTML(etiqueta)
})



leaflet(data = mapa_final, height = 600, width = 800) %>% 
  addTiles() %>% 
  addPolygons(label = etiquetas,
              labelOptions = labelOptions(textsize = "10px"),
              popup = etiquetas,
              weight = 1.75,
              color = "black",
              fillColor = "gray",
              opacity = 1.5,
              fillOpacity = 0.5,
              highlightOptions = highlightOptions(
                color = "#fc5203",
                weight = 2.5,
                opacity = 1.5,
                bringToFront = TRUE)
  ) 

setwd("G:/Unidades compartidas/Fiscalizacion Preventiva de Compras Publicas/Fiscalización Preventiva de Compras Públicas/10_Perfil_Instituciones_SICOP/AI")

```

### Tabla dinámica sobre ¿A quién se le compra? Tipo de empresas {.tabset .tabset-fade .tabset-pills}
En esta tabla dinámica se puede ver a primera vista el total gastado para cada tipo de proveedor por año. Aquí se pueden realizar los cambios anteriormente comentados.
```{r, out.width='100%', out.height='100%'}
# Create a copy of the original data frame
data_copy <- A_Quien_Contrata_Tipo_Empresas

# Modify the column names in the copied data frame
colnames(data_copy) <- c( "Tipo de proveedor","Año","Conteo de líneas", "Conteo de procedimientos" ,"Total gastado")

rpivotTable(data = data_copy, rows = c("Tipo de proveedor"),cols=c("Año"), vals = "Total gastado", aggregatorName = "Sum", rendererName = "Table", width="100%", height="500px")
```

### Tabla dinámica sobre ¿A quién se le compra? Cédula de empresas {.tabset .tabset-fade .tabset-pills}
En esta tabla dinámica se puede ver a primera vista el total gastado para cada cédula de empresa por año. Aquí se pueden realizar los cambios anteriormente comentados.
```{r, out.width='100%', out.height='100%'}
# Create a copy of the original data frame
data_copy <- A_Quien_Contrata_Empresas

# Modify the column names in the copied data frame
colnames(data_copy) <- c( "Cédula del proveedor","Año","Conteo de líneas", "Conteo de procedimientos" ,"Total gastado")

rpivotTable(data = data_copy , rows = c("Cédula del proveedor"),cols=c("Año"), vals = "Total gastado", aggregatorName = "Sum", rendererName = "Table", width="100%", height="500px")
```

## ANÁLISIS DEL MERCADO {.tabset .tabset-fade .tabset-pills}

### Tabla dinámica sobre Análisis del mercado: Poder de Mercado {.tabset .tabset-fade .tabset-pills}
En esta tabla dinámica se puede ver el Poder de Mercado que cada cédula de empresa tiene para cada producto. Este tiene formato de mapa de calor, por lo que entre más intenso es el color mayor poder de mercado poseen. Aquí se pueden realizar los cambios anteriormente comentados.
```{r, out.width='100%', out.height='100%'}
# Create a copy of the original data frame
data_copy <- Analisis_Mercado

# Modify the column names in the copied data frame
colnames(data_copy) <- c("Número de Acto","Número de Oferta","Número de Procedimiento","Fue Adjudicado","Cédula de la Institución","Cédula del Proveedor","Código del producto a 8 dígitos",                           "Tasa de Victoria","Tasa de Victoria última","Tasa de Victoria promedio","Varianza de la Tasa de Victoria","Poder de Mercado","Índice Herfindahl-Hirschman")

rpivotTable(data = data_copy, rows = c("Cédula del Proveedor","Código del producto a 8 dígitos"),vals = "Poder de Mercado", aggregatorName = "Average", rendererName = "Heatmap", width="100%", height="500px")
```

### Tabla dinámica sobre Análisis del mercado: IHH {.tabset .tabset-fade .tabset-pills}
En esta tabla dinámica se puede ver el Índice Herfindahl-Hirschman para cada producto, lo que indica que tan concetrado esta el mercado entre los proveedores. Este tiene formato de mapa de calor, por lo que entre más intenso es el color mayor concentrado está el mercado. Aquí se pueden realizar los cambios anteriormente comentados.
```{r, out.width='100%', out.height='100%'}
rpivotTable(data = data_copy, rows = c("Código del producto a 8 dígitos"),vals = "Índice Herfindahl-Hirschman", aggregatorName = "Average", rendererName = "Heatmap", width="100%", height="500px")
```
### Tabla dinámica sobre Análisis del mercado: Tasa de victoria {.tabset .tabset-fade .tabset-pills}
En esta tabla dinámica se puede ver la tasa de victoria por proveedor para cada producto, lo que indica que tan probable es que una oferta le sea adjudicada a este. Se incluyen los datos de la tasa promedio, su varianza y la última registrada. Aquí se pueden realizar los cambios anteriormente comentados.
```{r, out.width='100%', out.height='100%'}
# Create a copy of the original data frame

rpivotTable(data = data_copy, rows = c("Cédula del Proveedor","Código del producto a 8 dígitos","Tasa de Victoria","Tasa de Victoria promedio","Varianza de la Tasa de Victoria","Tasa de Victoria última"), rendererName = "Table", width="100%", height="500px")

```

```{r}
# inst <- list("INCIENSA","3007045313")
# 
# siglas <- inst[[1]]
# Institucion <- inst[[2]]
# 
# # Set the paths to the source file and the destination folder
# source_file <- file.path(getwd(), "Perfil-Institucional-2023.html")
# destination_folder <- paste0("G:/Unidades compartidas/Fiscalizacion Preventiva de Compras Publicas/Fiscalización Preventiva de Compras Públicas/10_Perfil_Instituciones_SICOP/AI/", "Perfil_2023_", siglas)
# 
# # Generate the destination path by combining the folder and new file name
# destination_file <- paste0("Perfil-Institucional_", siglas, ".html")
# destination_path <- file.path(destination_folder, destination_file)
# 
# # Check if the source file exists
# if (file.exists(source_file)) {
#   # Create the destination folder if it doesn't exist
#   dir.create(destination_folder, showWarnings = FALSE, recursive = TRUE)
# 
#   # Move the file by renaming it
#   if (file.rename(source_file, destination_path)) {
#     cat("File moved successfully.")
#   } else {
#     cat("Failed to move the file.")
#   }
# } else {
#   cat("Source file does not exist.")
# }
```

